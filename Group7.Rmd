---
title: "STATS 506 Group7 Project"
author: "Yan Chen, Aravind Mantravadi, Yingyi Yang"
date: "11/12/2020"
output: 
  html_document:
    toc: true
---

# **Introduction**

## **Topic concepts**
Regression models tell us about the effect of predictor variables on the response variable, but to find out the effect of specific predictors on the response, linear combinations are the way to go about it. Consider a regression model with response variable y and predictor variables x1, x2, x3 and x4. The regression model (without interactions) is:

$y = \alpha + \beta1*x1 + \beta2*x2 + \beta3*x3 + \beta4*x4$

If we want to make inferences about the effect x1 and x2 have on y, we need to create a linear combination of those variables

$y_{lc} = \beta1*x1 + \beta2*x2$

Of course just an estimate by itself doesn't tell us much, so we need to calculate standard errors, confidence intervals and p-values to know whether the effect is positive or negative and statistically significant.

## **Why is it useful?**

According to the World Health Organization (WHO), every year close to 800,000 people die due to suicide which is one person every 40 seconds. The results of survey conducted by WHO in 2016 shows that suicide the third leading cause of death in 15-19-year-olds. More than 79% of global suicides occurred in low and middle-income countries possibly due to pesticide self-poisoning in rural agricultural areas. Suicide is a global phenomenon and does not discriminate by age. The goal of this project is to demonstrate the use of Poisson regression in modeling suicide count data using demographic variables such as age and gender and make inferences on linear and non-linear combinations of regression coefficients.

We will be comparing the effect of age, gender and year in three pairs, where each pair has two of the variables at the same level.
We will be looking at the effect of:

1. 25-34 year old males in 2015 vs 25-34 year old males in 2005 on suicide count

2. 35-54 year old males in 2015 vs 35-54 year old females in 2015 on suicide count

3. 75+ males in 2015 vs 5-14 males in 2015 on suicide count

and draw inferences based on the estimates, confidence intervals and p-values obtained for each pair.

# **Outline** 

This project mainly includes exploratory data analysis, model fitting, linear and nonlinear combination investigation using three statistical analysis tools: R, Python and Stata. The results are also visualized by the corresponding packages in these tools. 

## **Data Description**
In this tutorial, we use the [1985-2016 Suicide Rates Overview Data](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016) which can be download from [Kaggle](https://www.kaggle.com). It is a compiled dataset pulled from four other datasets linked by time and place. It has 27820 records in total. The target variables we are going to analyze are:

`country`: country of the suicide records; 101 in total; countries in America and Europe occupy the majority 

`year`: year of the suicide records; range from 1985-2016.

`sex`: male and female   

`age`: age group of the suicide records; 6 groups: 5-14, 15-24, 25-34, 35-54, 55-74 and 75+

`suicides_no`: number of suicide  

`population`: total population of a country with given sex and year

`gdp_per_capita`: GDP per capita ($)


## **Model fitting**

Since the response variable `suicides_no` is count based, we have fitted Poisson regression model with `year`, `sex`, `age`, `gdp_per_capita` as the predictors. Basically, we want to maximize the joint likelihood function below

$$L(\beta) = \prod_{i=1}^n \frac{\lambda_i^{y_i} e^{-\lambda_i}}{y_i!}$$ 

where $\lambda_i$ is the event rate for ith sample and is calculated using the link function $\lambda_i = e^{x_i \beta}$. The log-likelihood function for the Poisson regression model is 

$$\ln L(\beta) = \sum_{i=1}^n (y_ix_i\beta-e^{x_i\beta}-\ln{y_i!})$$

After differentiating this log-likelihood equation with respect to $\beta$ and set to zero, we can get $\sum_{i=1}^n (y_i-e^{x_i\beta})x_i = 0$. Solving this equation for the regression coefficients $\beta$ $will yield the Maximum Likelihood Estimate (MLE) for $\beta$.

## **Software and Tools used**

We will demonstrate our core example in 3 programming languages: R, Python and Stata.

### **R**


To fit a Poisson regression model, we use the glm function in R. We use `log(population)` as the offset, `year`, `sex`, `age`, `gdp_per_capita` as the predictor variables and `suicide_count` as the response variable.

While R has an `esticon` function in the `doBy` package that calculates estimates, standard errors, confidence intervals and p-values for the desired linear combination, we did them by hand (and verified them using `esticon`). The vcov() function came in handy to store the variance-covariance matrix of the regression model.

To plot confidence intervals we used the ggplot package and plotted horizontal error bars for each pair of linear combinations.

### **Python**

Similarly, we use the glm function in Python statsmodels to fit the Poisson regression model. The parameter estimates along with the confidence interval are obtained by retrieving the paramter array and covariance matrix from the fitted model. The results are visualized by matplotlib.pyplot.

### **Stata**

We can fit the Poisson regression using `poisson` in Stata and use option 
`offset` to set an offset or use `exposure` which is equivalent to adding 
`offset(log_var)`. To get the estimated linear combination of coefficients, we 
can use `lincom`. It will output the point estimates, standard errors, t or z statistics, p-values, and confidence intervals. Similarly, we can use `nlcom` to
get the results for non-linear combination of coefficients.

# **Core Analysis** {.tabset .tabset-pills}

## Python


## R

```{r linear_combinations, echo=FALSE, message=FALSE, warning=FALSE, fig.width=15, fig.height=7}


# Construct the confidence interval figures
source('core_example.R')

      ## Create plots for each of the pairs of combinations ##


# 25-34 males, 2005 vs 2015 #
df1 = create_dataframe(male_25_34_2015, male_25_34_2005,
                       "25-34 Males, 2015", "25-34 Males, 2005")

plot_ci(dataset=df1)


# 35-54 in 2015, male vs female #

df2 = create_dataframe(male_35_54_2015, female_35_54_2015,
                       "35-54 Males, 2015", "35-54 Females, 2015")

plot_ci(dataset=df2)


# male in 2015, 75+ vs 5-14 #

df3 = create_dataframe(male_75_2015, male_5_14_2015,
                       "75+ Males, 2015", "5-14 Males, 2015")

plot_ci(dataset=df3)

```



## Stata
### Data Cleaning

First we will get the data from url and clean the data.
```{r, echo = TRUE, eval = FALSE}
* download and save data
local base_url ///
https://raw.githubusercontent.com/aravind1338/506F20GroupProject/main
import delimited `base_url'/master.csv, clear
keep ïcountry year sex age suicides_no population gdp_for_year 

* rename variables 
rename (ïcountry suicides_no gdp_for_year) ///
	   (country count gdp)

* convert gender from str to binary 
generate byte gender = 1 if sex == "male"
replace gender = 0 if sex == "female"
label define gender_label 0 "Female" 1 "Male" , replace
label values gender gender_label

* conveert gdp to numeric
destring gdp, replace ignore(",")

* convert age from string to categorical
generate byte age_group=1 if age == "5-14 years"
replace age_group = 2 if age == "15-24 years"
replace age_group = 3 if age == "25-34 years"
replace age_group = 4 if age == "35-54 years"
replace age_group = 5 if age == "55-74 years"
replace age_group = 6 if age == "75+ years"
label define ag_label 1 "5-14 years" 2 "15-24 years" 3 "25-34 years" ///
					  4 "35-54 years" 5 "55-74 years" 6 "75+ years"
label values age_group ag_label

* drop columns
drop sex age

* save data
save cleaned.dta, replace
use cleaned, clear 
```

### EDA
```{r, echo = TRUE, eval = FALSE}
tabstat count, by(gender) stats(mean sd n)
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/eda_gender.png?raw=true){width=200px}

```{r, echo = TRUE, eval = FALSE}
tabstat count, by(age_group) stats(mean sd n)
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/eda_age.png?raw=true){width=200px}

### Analysis

We can use function `poisson` to fit a Poisson regression model. 
Option `exposure(population)` means add log(population) as an offset. We can
also use option `offset(log_population)`. Option `irr` means to present the regression results as incident rate ratios.

```{r, echo = TRUE, eval = FALSE}
* Fit a Poisson model using age_group, year, gdp and gender
poisson count i.age_group i.gender i.year gdp, exposure(population), irr
```

Below is partial results of the moodel. Since there are many variables in the model and the results are too long to present, I only show several coefficients here.

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/poi_1.png?raw=true){width=400px}



#### Linear Commbination of Coefficient: example 1

In this example, we are trying to figure out the estimated difference between 
25-34 males in 2015 and 25-34 males 2005. So we first change the base level of
age to 24-34 and base level of gender to male and fit a Poisson model.

```{stata, echo = TRUE, eval = FALSE}
* Linear combinations of coefficients
** 25-34 males in 2015 vs 25-34 males 2005;  different year
** change the reference level to 25-34 and male
poisson count ib3.age_group ib1.gender i.year gdp, exposure(population), irr
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/poi_2.png?raw=true){width=400px}

Now we use funtcion `lincom` to get the estimated difference between the two 
coefficient in terms of incidence-rate ratios. 

`lincom` computes point estimates, 
standard errors, t or z statistics, p-values, and confidence
intervals for linear combinations of coefficients after any estimation command.
Results can optionally be displayed as incidence-rate ratios for poisson model.

The default levle of confidence interval is 95%, and we don't specify it in our model. 

```{stata eg1, echo = TRUE, eval = FALSE}
lincom 2015.year - 2005.year , irr 
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/l1.png?raw=true){width=400px}


#### Linear Commbination of Coefficient: example 2

In this example, we are trying to figure out the estimated difference between 
35-54 males in 2015 and 35-54 females 2015. So we first change the base level of
age to 35-54 and year to 2015 and fit a Poisson model.

```{stata eg2, echo = TRUE, eval = FALSE}
** 35-54 males in 2015 vs 35-54 females 2015; different gender
poisson count ib4.age_group i.gender ib2015.year gdp, exposure(population), irr
lincom 1.gender, irr
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/l2.png?raw=true){width=400px}


#### Linear Commbination of Coefficient: example 3
```{stata eg3, echo = TRUE, eval = FALSE}
** 75+ males in 2015 vs 15-24 males in 2015; different age
poisson count i.age_group ib1.gender ib2015.year gdp, exposure(population), irr
lincom 5.age_group - 2.age_group, irr
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/l3.png?raw=true){width=400px}


#### Non-linear Combination of Coefficient:
(details to be added)
```{stata nonlinear, echo = TRUE, eval = FALSE}
** non-linear combinations of coefficients: get the relative risk of a gender
poisson count i.age_group i.gender i.year gdp, exposure(population)
nlcom (E_gender:exp(_b[1.gender]))
```

![](https://github.com/aravind1338/506F20GroupProject/blob/main/STATA/Results/n1.png?raw=true){width=400px}



# **Conclusion/Discussion**

TODO



# **TODO**

* We need to estimate non-linear combinations of coefficients, and add explanations of what those mean in the Introduction
* We need to add a conclusion/discussion, comparing and contrasting the tools that were used.
* **R:** make the CI plots better by adjusting x-ticks and perhaps adding colors







